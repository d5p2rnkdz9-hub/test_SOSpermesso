---
phase: 01-foundation-assessment-core
plan: 03
type: execute
wave: 3
depends_on: ["01-01", "01-02"]
files_modified:
  - src/store/quiz-store.ts
  - src/hooks/useQuiz.ts
  - src/app/api/session/route.ts
  - src/app/api/session/[id]/route.ts
  - src/app/api/answers/route.ts
  - src/app/quiz/page.tsx
  - src/app/quiz/layout.tsx
  - src/components/quiz/QuizPlayer.tsx
  - src/components/quiz/NavigationButtons.tsx
  - prisma/seed.ts
autonomous: true
user_setup:
  - service: supabase
    why: "PostgreSQL database hosting"
    env_vars:
      - name: DATABASE_URL
        source: "Supabase Dashboard -> Project Settings -> Database -> Connection string (URI)"
    dashboard_config:
      - task: "Create new project"
        location: "supabase.com -> New Project"

must_haves:
  truths:
    - "User can start a new quiz session"
    - "User sees one question at a time"
    - "User can navigate forward with Next button"
    - "User can navigate backward with Back button"
    - "Answers persist across page refresh"
    - "Progress bar reflects completion percentage"
  artifacts:
    - path: "src/store/quiz-store.ts"
      provides: "Zustand store for quiz state"
      exports: ["useQuizStore"]
    - path: "src/app/api/session/route.ts"
      provides: "Session creation endpoint"
      exports: ["POST"]
    - path: "src/app/api/answers/route.ts"
      provides: "Answer persistence endpoint"
      exports: ["POST"]
    - path: "src/app/quiz/page.tsx"
      provides: "Quiz page"
      min_lines: 30
    - path: "prisma/seed.ts"
      provides: "Seed data with Italian questions"
      contains: "Quali strumenti AI"
  key_links:
    - from: "src/components/quiz/QuizPlayer.tsx"
      to: "src/store/quiz-store.ts"
      via: "useQuizStore hook"
      pattern: "useQuizStore"
    - from: "src/app/api/answers/route.ts"
      to: "src/lib/db.ts"
      via: "prisma.answer.upsert"
      pattern: "prisma\\.answer"
    - from: "src/store/quiz-store.ts"
      to: "/api/answers"
      via: "fetch on answer change"
      pattern: "fetch.*api/answers"
---

<objective>
Build the quiz engine: state management, session persistence, navigation, and question flow. Seed database with Italian questions from CONTEXT.md.

Purpose: This is the core quiz experience. Users can take the questionnaire with their answers saved after each question. If they close the browser and return, they can resume where they left off.

Output: Working quiz flow from start to completion with persistent sessions.
</objective>

<execution_context>
@/Users/albertopasquero/.claude/get-shit-done/workflows/execute-plan.md
@/Users/albertopasquero/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/01-foundation-assessment-core/01-CONTEXT.md
@.planning/phases/01-foundation-assessment-core/01-01-SUMMARY.md
@.planning/phases/01-foundation-assessment-core/01-02-SUMMARY.md
@src/types/quiz.ts
@prisma/schema.prisma
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Zustand store and API routes for session/answer persistence</name>
  <files>
    src/store/quiz-store.ts
    src/hooks/useQuiz.ts
    src/app/api/session/route.ts
    src/app/api/session/[id]/route.ts
    src/app/api/answers/route.ts
  </files>
  <action>
**src/store/quiz-store.ts** - Zustand store for client state:
```typescript
interface QuizState {
  // Session
  sessionId: string | null
  resumeToken: string | null

  // Quiz progress
  questions: Question[]
  currentIndex: number
  answers: Record<string, any>  // questionId -> answer value

  // Status
  isLoading: boolean
  isComplete: boolean

  // Actions
  initSession: (surveyId: string) => Promise<void>
  resumeSession: (resumeToken: string) => Promise<void>
  setAnswer: (questionId: string, value: any) => Promise<void>
  nextQuestion: () => void
  prevQuestion: () => void
  completeQuiz: () => Promise<void>

  // Computed (via getters)
  currentQuestion: () => Question | null
  progress: () => number  // 0-100
  canGoBack: () => boolean
  canGoNext: () => boolean
}
```
- Auto-save answer to API when setAnswer called (debounced 500ms)
- Store resumeToken in localStorage for resume capability
- Handle branching: nextQuestion checks if current answer triggers branch

**src/hooks/useQuiz.ts** - Hook wrapping store with computed values:
- Expose currentQuestion, progress, canGoBack, canGoNext as computed
- Handle question visibility based on showCondition (from Q2 branching)
- Build visible question list dynamically based on answers

**API Routes:**

**POST /api/session** - Create new session:
- Body: { surveyId: string }
- Creates Session record with new resumeToken
- Returns: { sessionId, resumeToken, questions, currentIndex }

**GET /api/session/[id]** - Resume session:
- Param: resumeToken
- Returns session with all questions and existing answers
- If completed, returns { isComplete: true, feedback }

**POST /api/answers** - Save answer:
- Body: { sessionId, questionId, value }
- Upserts Answer record (create or update)
- Updates Session.currentIndex
- Returns: { success: true }

All API routes:
- Use Prisma client from @/lib/db
- Handle errors gracefully with proper status codes
- Return JSON responses
  </action>
  <verify>
Test with curl or API client:
1. POST /api/session with surveyId -> returns session with resumeToken
2. POST /api/answers with answer data -> returns success
3. GET /api/session/[resumeToken] -> returns session with saved answers
`npx tsc --noEmit` passes.
  </verify>
  <done>
Zustand store manages quiz state, API routes handle persistence, answers auto-save after each question.
  </done>
</task>

<task type="auto">
  <name>Task 2: Build QuizPlayer component and seed Italian questions</name>
  <files>
    src/components/quiz/QuizPlayer.tsx
    src/components/quiz/NavigationButtons.tsx
    src/app/quiz/page.tsx
    src/app/quiz/layout.tsx
    prisma/seed.ts
    package.json
  </files>
  <action>
**prisma/seed.ts** - Seed database with Italian questions from CONTEXT.md:

Create Survey with id "ai-screening-v1" and these questions:

| Order | ID | Text | Type | Options/Notes |
|-------|-----|------|------|---------------|
| 1 | q1-tools | "Quali strumenti AI hai usato?" | MULTIPLE_CHOICE | ChatGPT, Claude, Gemini, Copilot, Banca dati giuridica con AI, Nessuno, Altro |
| 2 | q2-work | "Hai usato AI per il lavoro legale?" | YES_NO | Branch trigger |
| 3 | q2a-howused | "Per cosa hai usato l'AI nel lavoro?" | MULTIPLE_CHOICE | Ricerca giuridica, Studio di documenti, Scrittura/redazione, Altro. showCondition: q2-work = true |
| 4 | q2b-trend | "Come sta cambiando il tuo utilizzo?" | SINGLE_CHOICE | In aumento, Stabile, In diminuzione. showCondition: q2-work = true |
| 5 | q2c-satisfaction | "Come ti trovi con questi strumenti?" | SINGLE_CHOICE | Frustrato, Neutrale, Soddisfatto, Entusiasta. showCondition: q2-work = true |
| 6 | q2d-whynot | "Perche non hai usato AI nel lavoro?" | MULTIPLE_CHOICE | Preoccupazioni sulla privacy, Non ho avuto tempo, Paura di commettere errori, Non ne vedo il valore, Altro. showCondition: q2-work = false |
| 7 | q3-profile | "Quale profilo ti descrive meglio?" | PROFILE_SELECT | Three profiles from CONTEXT.md (Profilo A/B/C with full Italian descriptions) |
| 8 | q4-expectations | "Cosa speri di imparare da questo corso?" | TEXT | Key open question |
| 9 | q5-concerns | "Quali sono le tue preoccupazioni sull'uso dell'AI?" | MULTIPLE_CHOICE | Privacy e riservatezza dei dati, Implicazioni etiche e deontologiche, Affidabilita e accuratezza, Altro (con campo testo opzionale) |
| 10 | q6-usecases | "Per cosa vorresti usare l'AI nel tuo lavoro?" | RANKING | Ricerca giuridica, Scrittura documenti, Revisione contratti, Comunicazione con i clienti, Gestione dello studio, Altro. maxSelections: 3 |

Add to package.json scripts:
```json
"db:seed": "npx prisma db seed"
```

Add to package.json:
```json
"prisma": {
  "seed": "npx tsx prisma/seed.ts"
}
```

Install tsx: `npm install -D tsx`

**src/components/quiz/QuizPlayer.tsx** - Main quiz orchestrator:
- Uses useQuiz hook for state
- Renders current question using appropriate component (switch on type)
- Shows ProgressBar at top
- Shows NavigationButtons at bottom
- Handles loading and error states
- On last question, shows "Completa" instead of "Avanti"

**src/components/quiz/NavigationButtons.tsx**:
- "Indietro" button (disabled on first question)
- "Avanti" / "Completa" button (disabled if answer required but missing)
- Brand styling (blue buttons)
- Clear keyboard focus states

**src/app/quiz/layout.tsx**:
- Clean layout without header/footer clutter
- Max-width container centered
- DigiCrazy Lab branded background (subtle)

**src/app/quiz/page.tsx**:
- Entry point for quiz
- Checks for resumeToken in URL or localStorage
- If found, resumes session
- If not, creates new session for default survey
- Renders QuizPlayer
- On completion, redirects to /quiz/results (placeholder for now)

Run `npx prisma db push` to create tables.
Run `npm run db:seed` to populate questions.
  </action>
  <verify>
1. `npx prisma db push` succeeds (requires user to have DATABASE_URL set)
2. `npm run db:seed` populates survey and questions
3. Visit localhost:3000/quiz - should show first question
4. Answer and click Avanti - should progress to next question
5. Click Indietro - should go back
6. Refresh page - should resume at same question with saved answers
7. Answer Q2 "Si" - should show Q2a, Q2b, Q2c
8. Answer Q2 "No" - should show Q2d instead
  </verify>
  <done>
Complete quiz flow working: start session, answer questions, navigate forward/back, answers persist, branching works based on Q2 answer.
  </done>
</task>

</tasks>

<verification>
1. New session creates with resumeToken
2. Answers save automatically (check database or API response)
3. Page refresh resumes session at correct question
4. Navigation respects question requirements (can't skip without answering)
5. Branching logic works: Q2=Si shows 2a/2b/2c, Q2=No shows 2d
6. Progress bar updates correctly
7. All questions render with correct Italian text
</verification>

<success_criteria>
- User can complete full questionnaire flow
- Answers persist across browser refresh
- Branching on Q2 works correctly (YES path vs NO path)
- Progress bar shows accurate completion percentage
- Navigation (Indietro/Avanti) works correctly
- All 10 questions seeded with Italian content
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-assessment-core/01-03-SUMMARY.md`
</output>
