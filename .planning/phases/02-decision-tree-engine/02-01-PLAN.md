---
phase: 02-decision-tree-engine
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/types/tree.ts
  - src/lib/tree-data.ts
  - src/lib/tree-engine.ts
  - messages/it.json
autonomous: true

must_haves:
  truths:
    - "Tree data contains all 46 question nodes and 29 result nodes from existing data.js"
    - "Every edge target resolves to a valid node (no broken links)"
    - "All 8 main paths (minor, family, partner, fear, health, pregnancy, exploitation, born in Italy) are reachable from q_situazione"
    - "Engine functions correctly traverse the graph given a node ID and option key"
  artifacts:
    - path: "src/types/tree.ts"
      provides: "TreeNode, TreeEdge, TreeData, TreeSession types"
      exports: ["TreeNode", "TreeEdge", "TreeData"]
    - path: "src/lib/tree-data.ts"
      provides: "Complete Italian decision tree as static TypeScript data"
      exports: ["italianTree"]
      contains: "startNodeId.*start"
    - path: "src/lib/tree-engine.ts"
      provides: "Pure functions for graph traversal"
      exports: ["getOptionsForNode", "getNextNodeId", "isTerminalNode", "getNode", "validateTree"]
    - path: "messages/it.json"
      provides: "Italian UI strings for tree screens"
      contains: "tree"
  key_links:
    - from: "src/lib/tree-data.ts"
      to: "src/types/tree.ts"
      via: "imports TreeData type"
      pattern: "import.*TreeData.*from.*types/tree"
    - from: "src/lib/tree-engine.ts"
      to: "src/types/tree.ts"
      via: "imports TreeData, TreeEdge, TreeNode types"
      pattern: "import.*TreeData.*from.*types/tree"
    - from: "src/lib/tree-data.ts"
      to: "TYPEFORM_CLONE/data.js"
      via: "content converted from JS to typed TS"
      pattern: "75 total nodes"
---

<objective>
Create the decision tree data foundation: TypeScript types, the complete Italian tree data structure converted from existing data.js, pure traversal functions, and Italian UI strings.

Purpose: This is the data layer that everything else in Phase 2 depends on. The tree data (75 nodes, ~100 edges) and engine (pure functions) must be correct before building UI or state management on top.
Output: Types, tree data file, engine functions, and i18n message extensions -- all importable by subsequent plans.
</objective>

<execution_context>
@/Users/albertopasquero/.claude/get-shit-done/workflows/execute-plan.md
@/Users/albertopasquero/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-decision-tree-engine/02-RESEARCH.md
@.planning/phases/02-decision-tree-engine/02-CONTEXT.md

Source data to convert:
@/Users/albertopasquero/Desktop/TECH/SOSpermesso/TYPEFORM_CLONE/data.js

Existing message file to extend:
@messages/it.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create tree types, data, and engine</name>
  <files>
    src/types/tree.ts
    src/lib/tree-data.ts
    src/lib/tree-engine.ts
  </files>
  <action>
    **1. Create `src/types/tree.ts`:**
    Define TypeScript interfaces for the decision tree:
    - `TreeNode` with fields: `id: string`, `type: 'question' | 'result'`, `question?: string`, `description?: string`, `title?: string`, `resultDescription?: string`, `duration?: string`, `requirements?: string[]`, `notes?: string`, `link?: string`
    - `TreeEdge` with fields: `from: string`, `to: string`, `label: string`, `description?: string`, `optionKey: string`
    - `TreeData` with fields: `nodes: Record<string, TreeNode>`, `edges: TreeEdge[]`, `startNodeId: string`

    **2. Create `src/lib/tree-data.ts`:**
    Convert the entire `TYPEFORM_CLONE/data.js` `flowData` object into a typed `TreeData` export named `italianTree`.
    - The source file at `/Users/albertopasquero/Desktop/TECH/SOSpermesso/TYPEFORM_CLONE/data.js` has the complete content.
    - Each key in `flowData` becomes a node in `nodes`. Questions have `type: 'question'`, results have `type: 'result'`.
    - Each answer in a node's `answers` array becomes an edge: `{ from: nodeId, to: answer.next, label: answer.text, optionKey: }`. Generate optionKeys by sanitizing the answer text to a short snake_case identifier (e.g., "Si, sono cittadino UE" -> "si_ue", "Ho meno di 18 anni" -> "minore"). Keys must be unique within each question's edges.
    - Keep emoji prefixes in result titles (they're part of the SOSpermesso design language).
    - Preserve all Italian text exactly as written in data.js. Do not translate or modify content.
    - IMPORTANT: Keep min_affido1 through min_affido5 as SEPARATE nodes. They share question text but have different graph positions. Do NOT merge them. See Research pitfall #6.
    - Total expected: 46 question nodes + 29 result nodes = 75 nodes, approximately 100 edges.
    - `startNodeId` should be `'start'`.

    **3. Create `src/lib/tree-engine.ts`:**
    Implement pure functions that take `TreeData` as a parameter (no global imports of the tree data -- functions should be pure):
    - `getOptionsForNode(tree: TreeData, nodeId: string): TreeEdge[]` -- returns all edges where `from === nodeId`, preserving order from the edges array.
    - `getNextNodeId(tree: TreeData, currentNodeId: string, optionKey: string): string | null` -- finds the edge matching `from` and `optionKey`, returns `to`. Returns null if no match.
    - `isTerminalNode(tree: TreeData, nodeId: string): boolean` -- returns true if `nodes[nodeId]?.type === 'result'`.
    - `getNode(tree: TreeData, nodeId: string): TreeNode | undefined` -- simple lookup.
    - `validateTree(tree: TreeData): string[]` -- returns array of error strings. Checks: (a) start node exists, (b) all edge `from` and `to` reference existing nodes, (c) all question nodes have at least one outgoing edge, (d) all result nodes have zero outgoing edges, (e) all nodes are reachable from start via BFS/DFS.
  </action>
  <verify>
    Run `npx tsc --noEmit` to verify type checking passes. Then create a quick validation by running:
    ```
    npx tsx -e "
      const { italianTree } = require('./src/lib/tree-data');
      const { validateTree, getOptionsForNode } = require('./src/lib/tree-engine');
      const errors = validateTree(italianTree);
      console.log('Nodes:', Object.keys(italianTree.nodes).length);
      console.log('Edges:', italianTree.edges.length);
      console.log('Questions:', Object.values(italianTree.nodes).filter(n => n.type === 'question').length);
      console.log('Results:', Object.values(italianTree.nodes).filter(n => n.type === 'result').length);
      console.log('Validation errors:', errors.length === 0 ? 'NONE' : errors);
      console.log('Start options:', getOptionsForNode(italianTree, 'start').length);
    "
    ```
    Expected: 75 nodes (46 questions, 29 results), ~100 edges, 0 validation errors, 2 start options.
  </verify>
  <done>
    - TypeScript compiles with no errors
    - Tree data contains exactly 75 nodes (46 questions + 29 results)
    - validateTree returns zero errors
    - All engine functions return correct values for known inputs (start node has 2 options, q_situazione has 9 options)
  </done>
</task>

<task type="auto">
  <name>Task 2: Extend Italian i18n messages for tree UI</name>
  <files>
    messages/it.json
  </files>
  <action>
    Add a `"tree"` key to `messages/it.json` with Italian UI strings for the decision tree screens. These are UI chrome strings (button labels, prompts), NOT the tree content itself (which lives in tree-data.ts).

    Add these keys under `"tree"`:
    ```json
    {
      "tree": {
        "nameLabel": "Come ti chiami?",
        "namePlaceholder": "Il tuo nome (facoltativo)",
        "skipName": "Preferisco non dirlo",
        "explainer": "Rispondi ad alcune domande per scoprire quale permesso di soggiorno puoi richiedere in Italia.",
        "disclaimer": "Questo strumento fornisce informazioni generali e non costituisce consulenza legale.",
        "startButton": "Inizia la verifica",
        "restart": "Ricomincia",
        "outcome": {
          "title": "Il tuo risultato",
          "duration": "Durata",
          "requirements": "Requisiti",
          "notes": "Note importanti",
          "moreInfo": "Maggiori informazioni",
          "restart": "Ricomincia la verifica"
        }
      }
    }
    ```

    Keep all existing keys (`common`, `welcome`, `header`, `language`) unchanged. Just add the `tree` block.

    Also add `"back"` to the `"common"` section if it is not already present (it should be -- verify first).
  </action>
  <verify>
    Read `messages/it.json` and confirm it is valid JSON with the new `tree` key and all existing keys preserved. Run `node -e "JSON.parse(require('fs').readFileSync('messages/it.json', 'utf8')); console.log('Valid JSON')"` from the app directory.
  </verify>
  <done>
    - messages/it.json is valid JSON
    - Contains `tree.nameLabel`, `tree.namePlaceholder`, `tree.skipName`, `tree.explainer`, `tree.disclaimer`, `tree.startButton`, `tree.restart`, `tree.outcome.title`, `tree.outcome.duration`, `tree.outcome.requirements`, `tree.outcome.notes`, `tree.outcome.moreInfo`, `tree.outcome.restart`
    - All pre-existing keys unchanged
    - `common.back` exists
  </done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes (all new TypeScript files compile cleanly)
- Tree validation function confirms 0 errors on the Italian tree
- Node and edge counts match source data.js (75 nodes, ~100 edges)
- messages/it.json is valid JSON with tree keys
</verification>

<success_criteria>
1. `src/types/tree.ts` exports TreeNode, TreeEdge, TreeData types
2. `src/lib/tree-data.ts` exports `italianTree` with all 75 nodes from data.js
3. `src/lib/tree-engine.ts` exports 5 pure functions that correctly traverse the tree
4. `messages/it.json` has tree UI strings in Italian
5. validateTree(italianTree) returns an empty array (no integrity issues)
</success_criteria>

<output>
After completion, create `.planning/phases/02-decision-tree-engine/02-01-SUMMARY.md`
</output>
