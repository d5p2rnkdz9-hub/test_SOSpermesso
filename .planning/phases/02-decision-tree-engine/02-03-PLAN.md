---
phase: 02-decision-tree-engine
plan: 03
type: execute
wave: 3
depends_on: ["02-01", "02-02"]
files_modified:
  - src/app/[locale]/tree/page.tsx
  - src/app/[locale]/tree/TreeContent.tsx
  - src/app/[locale]/page.tsx
  - src/components/layout/StickyHeader.tsx
  - src/components/tree/BackButton.tsx
autonomous: false

must_haves:
  truths:
    - "User can enter their name on the welcome page and start the questionnaire"
    - "User can skip name entry and start the questionnaire"
    - "Navigating to /[locale]/tree shows the current question (or resumes from localStorage)"
    - "Back button appears in the header when the user has navigation history"
    - "Back button disappears when at the first question"
    - "Reaching a terminal node shows a basic outcome screen with title and description"
    - "User who closes the browser and returns sees their previous question (session resume)"
  artifacts:
    - path: "src/app/[locale]/tree/page.tsx"
      provides: "Server component for the tree route"
      contains: "setRequestLocale"
    - path: "src/app/[locale]/tree/TreeContent.tsx"
      provides: "Client component orchestrating tree display with hydration handling"
      exports: ["default"]
      contains: "isHydrated"
    - path: "src/app/[locale]/page.tsx"
      provides: "Updated welcome page with name input"
      contains: "tree.nameLabel"
    - path: "src/components/layout/StickyHeader.tsx"
      provides: "Updated header with back button slot"
      contains: "BackButton"
    - path: "src/components/tree/BackButton.tsx"
      provides: "Back button component for header"
      exports: ["BackButton"]
      contains: "goBack"
  key_links:
    - from: "src/app/[locale]/tree/TreeContent.tsx"
      to: "src/store/tree-store.ts"
      via: "reads currentNodeId, outcomeId, isHydrated"
      pattern: "useTreeStore"
    - from: "src/app/[locale]/tree/TreeContent.tsx"
      to: "src/components/tree/TreePlayer.tsx"
      via: "renders TreePlayer for question nodes"
      pattern: "TreePlayer"
    - from: "src/app/[locale]/page.tsx"
      to: "src/store/tree-store.ts"
      via: "calls startSession on form submit"
      pattern: "startSession"
    - from: "src/components/tree/BackButton.tsx"
      to: "src/store/tree-store.ts"
      via: "calls goBack action"
      pattern: "goBack"
    - from: "src/components/layout/StickyHeader.tsx"
      to: "src/components/tree/BackButton.tsx"
      via: "renders BackButton in header"
      pattern: "BackButton"
    - from: "src/app/[locale]/page.tsx"
      to: "/[locale]/tree"
      via: "router.push after startSession"
      pattern: "router.*push.*tree"
---

<objective>
Wire the tree engine into the app: create the /tree page route with hydration handling, update the welcome page with name input and session start, and add the back button to the sticky header.

Purpose: This connects all the pieces from Plans 01 and 02 into a working end-to-end flow. After this plan, a user can enter their name, navigate questions, go back, and resume sessions.
Output: A fully functional decision tree questionnaire accessible from the welcome page.
</objective>

<execution_context>
@/Users/albertopasquero/.claude/get-shit-done/workflows/execute-plan.md
@/Users/albertopasquero/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-decision-tree-engine/02-RESEARCH.md
@.planning/phases/02-decision-tree-engine/02-CONTEXT.md
@.planning/phases/02-decision-tree-engine/02-01-SUMMARY.md
@.planning/phases/02-decision-tree-engine/02-02-SUMMARY.md

Existing files being modified:
@src/app/[locale]/page.tsx
@src/components/layout/StickyHeader.tsx
@src/app/[locale]/layout.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create tree page route and TreeContent orchestrator</name>
  <files>
    src/app/[locale]/tree/page.tsx
    src/app/[locale]/tree/TreeContent.tsx
  </files>
  <action>
    **1. Create `src/app/[locale]/tree/page.tsx`:**
    Server component for the tree route, following the same pattern as the welcome page.
    ```tsx
    import { setRequestLocale } from 'next-intl/server';
    import TreeContent from './TreeContent';

    type Props = {
      params: Promise<{ locale: string }>;
    };

    export default async function TreePage({ params }: Props) {
      const { locale } = await params;
      setRequestLocale(locale);
      return <TreeContent />;
    }
    ```

    **2. Create `src/app/[locale]/tree/TreeContent.tsx`:**
    Client component (`'use client'`) that orchestrates the tree display.

    Logic:
    - Read `isHydrated`, `currentNodeId`, `outcomeId`, `userName`, `history` from `useTreeStore`.
    - **Hydration guard:** If `!isHydrated`, show a loading state (centered `Loader2` spinner from lucide-react inside `ContentColumn`). This prevents the flash of wrong content on session resume (see Research pitfall #4).
    - **No session check:** If `isHydrated` and `userName === null` and `history.length === 0` and `currentNodeId === italianTree.startNodeId`, redirect to welcome page using `useRouter` from `@/i18n/navigation`. This handles direct URL access to /tree without going through welcome.
    - **Outcome screen:** If `outcomeId` is set and `isTerminalNode(italianTree, outcomeId)`:
      - Get the result node via `getNode(italianTree, outcomeId)`.
      - Render a basic outcome display inside `ContentColumn`:
        - Title: `text-2xl font-bold`
        - Description: `mt-4 text-foreground/80`
        - Duration (if present): labeled with `t('tree.outcome.duration')`
        - Requirements (if present): bulleted list labeled with `t('tree.outcome.requirements')`
        - Notes (if present): labeled with `t('tree.outcome.notes')`
        - Link (if present): external link labeled with `t('tree.outcome.moreInfo')`, opens in new tab
        - Restart button at bottom: calls `reset()` and redirects to welcome page. Uses `t('tree.outcome.restart')`.
      - Note: This is a MINIMAL outcome display for Phase 2. Phase 3 will build rich outcome pages with collapsible sections, variable substitution, etc.
    - **Question screen:** Otherwise, render `<ContentColumn><TreePlayer /></ContentColumn>`.

    Use `useTranslations('tree')` for all UI text.
  </action>
  <verify>
    `npx tsc --noEmit` passes. Both files exist. Run `npm run build` (or `npx next build`) to verify the route compiles. The /tree route should be accessible in the build output.
  </verify>
  <done>
    - `/[locale]/tree` route exists and renders TreeContent
    - TreeContent handles 3 states: loading (hydration), outcome display, question display
    - Direct /tree access without session redirects to welcome
    - Outcome screen shows title, description, duration, requirements, notes, link
    - TypeScript compiles cleanly
  </done>
</task>

<task type="auto">
  <name>Task 2: Update welcome page with name input and add back button to header</name>
  <files>
    src/app/[locale]/page.tsx
    src/components/layout/StickyHeader.tsx
    src/components/tree/BackButton.tsx
  </files>
  <action>
    **1. Create `src/components/tree/BackButton.tsx`:**
    Client component that renders a back button for the sticky header.
    - `'use client'` directive.
    - Import `ArrowLeft` from `lucide-react`.
    - Import `useTreeStore` from `@/store/tree-store`.
    - Import `useTranslations` from `next-intl`.
    - Read `history` and `goBack` from store.
    - If `history.length === 0`, return `null` (no back button when at start).
    - Render a `<button>` with:
      - `onClick={goBack}`
      - `aria-label={t('common.back')}`
      - `className="flex items-center gap-1 text-sm font-medium text-foreground"`
      - `<ArrowLeft className="h-5 w-5 rtl:rotate-180" />` (mirrors for RTL)
      - `<span className="hidden sm:inline">{t('common.back')}</span>` (text hidden on mobile, icon only)

    Also update `src/components/tree/index.ts` to add the BackButton export.

    **2. Update `src/components/layout/StickyHeader.tsx`:**
    Add the BackButton to the header, positioned before the logo.
    - Import `BackButton` from `@/components/tree/BackButton`.
    - Modify the header layout:
      - The left side should show either BackButton (if visible) or the logo.
      - Actually, show BOTH: BackButton on the far left, logo in the center-ish area, language selector on the right.
      - Simpler approach: Add BackButton before the logo link. When BackButton renders null (no history), nothing changes. When it renders, it appears to the left of the logo.
      - Layout: `<div className="flex items-center gap-2"><BackButton /><a ...>SOSpermesso</a></div>` on the left, `<LanguageSelector />` on the right.
    - The StickyHeader is a server component currently. Since BackButton is a client component with `'use client'`, it can be imported and rendered within the server component -- React handles the boundary. No need to convert StickyHeader to client component.

    **3. Update `src/app/[locale]/page.tsx` (welcome page):**
    Transform from a simple start button to include name input, explainer, and legal disclaimer. The page must be partially converted to use client-side features (for name input and router).

    Create a new `WelcomeContent` as a `'use client'` component (can be inline in the same file or extracted):
    - Import `useTreeStore` from `@/store/tree-store`.
    - Import `useRouter` from `@/i18n/navigation`.
    - Import `useTranslations` from `next-intl`.
    - Local state: `name: string` (controlled input).
    - On form submit or "start" button click:
      1. Call `startSession(name.trim() || null)` from tree store.
      2. Call `router.push('/tree')` to navigate.
    - On "skip name" click:
      1. Call `startSession(null)`.
      2. Call `router.push('/tree')`.

    Layout inside `ContentColumn`:
    - Title: `t('welcome.title')` -- keep existing.
    - Explainer text: `t('tree.explainer')` -- "Rispondi ad alcune domande per scoprire..."
    - Name input section:
      - Label: `t('tree.nameLabel')` -- "Come ti chiami?"
      - `<input>` with: `type="text"`, `placeholder={t('tree.namePlaceholder')}`, `value={name}`, `onChange`, `className="w-full rounded-xl border-2 border-foreground bg-card px-4 py-3 text-lg placeholder:text-foreground/40 focus:outline-none focus:ring-2 focus:ring-foreground"`.
    - Start button: `t('tree.startButton')` -- uses the existing `<Button>` component from shadcn/ui, `size="lg"`, full width.
    - Skip name link: `t('tree.skipName')` -- styled as a text button/link below the start button: `text-sm text-foreground/60 underline`.
    - Legal disclaimer: `t('tree.disclaimer')` at the bottom, small muted text.

    IMPORTANT: The welcome page is currently a server component. The name input requires client interaction. Split it: keep the server component wrapper (for `setRequestLocale`) and create a client component for the interactive content.

    Check if there's an existing session in the store (user returning). If `isHydrated && history.length > 0`, show a "Continue where you left off" prompt instead of the name input. Use auto-resume: automatically redirect to /tree. Actually, per Research open question #1 recommendation: auto-resume silently. If the store has an active session (history.length > 0 and currentNodeId !== startNodeId), redirect to /tree on mount. Add a small delay or use useEffect to avoid SSR issues.
  </action>
  <verify>
    `npx tsc --noEmit` passes. Run `npm run dev` and verify:
    1. Welcome page shows name input, start button, skip name link, explainer, disclaimer
    2. Entering a name and clicking start navigates to /tree
    3. Skipping name navigates to /tree
    4. Back button appears in header after navigating past first question
    5. Back button disappears at first question
    6. After closing and reopening browser, /tree resumes at previous question
  </verify>
  <done>
    - Welcome page has name input with label and placeholder
    - Skip name option available
    - Explainer and legal disclaimer shown
    - Start button stores name and navigates to /tree
    - BackButton renders in StickyHeader when history exists
    - BackButton mirrors (ArrowLeft rotates 180) in RTL
    - Auto-resume: returning user with active session redirects to /tree
    - TypeScript compiles cleanly
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Complete decision tree flow: welcome page with name input -> branching questions with tap-to-advance -> slide transitions -> back navigation -> outcome display -> session persistence across browser close.
  </what-built>
  <how-to-verify>
    Run `npm run dev` and test in browser at http://localhost:3000/it:

    1. **Welcome page:** Verify name input, explainer text, disclaimer, start button, and skip name link are visible
    2. **Name entry flow:** Enter a name, click start. Verify you arrive at the first question ("Hai la cittadinanza di un Paese dell'Unione Europea?")
    3. **Tap-to-advance:** Tap "No, non sono cittadino UE". Verify slide transition to the situation question. Verify the 9 options are grouped into categories with headings
    4. **Path traversal:** Navigate a complete path. Try "Ho meno di 18 anni" -> "No, nessun genitore" -> "Nessun parente in Italia". Verify you reach the MSNA outcome page
    5. **Back navigation:** Press back button in header. Verify previous question shows with your previous answer highlighted. Press back again to q_situazione -- verify your "Ho meno di 18 anni" selection is highlighted
    6. **Branch change:** From q_situazione, select "Ho paura di tornare nel mio Paese" instead. Navigate through to an outcome. Verify the old minor path answers are gone (go back -- you should NOT see minore questions)
    7. **Session persistence:** While on a mid-question, close the browser tab completely. Reopen http://localhost:3000/it/tree. Verify you resume at the same question with all previous answers intact
    8. **RTL test:** Switch to Arabic (ar) via language selector. Verify back button arrow mirrors, slide transitions go opposite direction, answer cards use text-start
    9. **Mobile test:** Resize to 320px width. Verify answer cards have adequate touch targets and no horizontal scroll

    Report any issues with transitions, navigation, or visual rendering.
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes
- `npm run build` succeeds (no build errors)
- All 8 main paths reachable and terminate at correct outcomes
- Back navigation follows branching path, not flat sequence
- Session persists in localStorage across browser close
- RTL layout mirrors correctly
- Mobile touch targets are 48px+
</verification>

<success_criteria>
1. Welcome page collects name (or skips) and starts session
2. /tree route renders current question with answer cards
3. Tap-to-advance works (select -> immediate slide to next)
4. Back button in header goes to previous question with answer preserved
5. Changing answer after going back discards downstream silently
6. Closing browser and returning resumes at same question
7. Terminal nodes show basic outcome (title, description, requirements)
8. q_situazione options grouped into categories visually
9. RTL support works (arrow mirrors, transitions mirror, text-start)
</success_criteria>

<output>
After completion, create `.planning/phases/02-decision-tree-engine/02-03-SUMMARY.md`
</output>
