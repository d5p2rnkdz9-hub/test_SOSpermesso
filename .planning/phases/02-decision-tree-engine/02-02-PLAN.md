---
phase: 02-decision-tree-engine
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - src/store/tree-store.ts
  - src/components/tree/AnswerCard.tsx
  - src/components/tree/QuestionScreen.tsx
  - src/components/tree/SlideTransition.tsx
  - src/components/tree/TreePlayer.tsx
  - src/components/tree/index.ts
autonomous: true

must_haves:
  truths:
    - "Selecting an answer immediately advances to the next question (tap-to-advance, no confirm button)"
    - "Going back shows the previous question with the previously selected answer highlighted"
    - "Changing an answer after going back silently discards all downstream answers on the old branch"
    - "Session state persists to localStorage and survives page refresh"
    - "Questions slide in from the right going forward and from the left going back"
  artifacts:
    - path: "src/store/tree-store.ts"
      provides: "Zustand store with persist middleware for tree session"
      exports: ["useTreeStore"]
      contains: "persist"
    - path: "src/components/tree/TreePlayer.tsx"
      provides: "Main tree orchestrator component"
      exports: ["TreePlayer"]
      contains: "useTreeStore"
    - path: "src/components/tree/QuestionScreen.tsx"
      provides: "Single question rendering with answer options"
      exports: ["QuestionScreen"]
    - path: "src/components/tree/AnswerCard.tsx"
      provides: "Tappable answer option card"
      exports: ["AnswerCard"]
      min_lines: 15
    - path: "src/components/tree/SlideTransition.tsx"
      provides: "CSS slide transition wrapper"
      exports: ["SlideTransition"]
    - path: "src/components/tree/index.ts"
      provides: "Barrel exports for tree components"
  key_links:
    - from: "src/store/tree-store.ts"
      to: "src/lib/tree-engine.ts"
      via: "imports getNextNodeId, isTerminalNode for traversal"
      pattern: "import.*getNextNodeId.*from.*tree-engine"
    - from: "src/store/tree-store.ts"
      to: "src/lib/tree-data.ts"
      via: "imports italianTree for the data"
      pattern: "import.*italianTree.*from.*tree-data"
    - from: "src/components/tree/TreePlayer.tsx"
      to: "src/store/tree-store.ts"
      via: "reads currentNodeId, answers, selectOption from store"
      pattern: "useTreeStore"
    - from: "src/components/tree/TreePlayer.tsx"
      to: "src/lib/tree-engine.ts"
      via: "calls getOptionsForNode, getNode"
      pattern: "getOptionsForNode|getNode"
    - from: "src/store/tree-store.ts"
      to: "localStorage"
      via: "Zustand persist middleware with 'sospermesso-tree-session' key"
      pattern: "sospermesso-tree-session"
---

<objective>
Build the Zustand tree store with localStorage persistence and all tree UI components (AnswerCard, QuestionScreen, SlideTransition, TreePlayer).

Purpose: This creates the interactive engine -- state management for tree traversal, back navigation with downstream answer discard, and the visual components that render questions with tap-to-advance behavior and slide transitions.
Output: A fully functional tree store and component set ready to be wired into a page route.
</objective>

<execution_context>
@/Users/albertopasquero/.claude/get-shit-done/workflows/execute-plan.md
@/Users/albertopasquero/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-decision-tree-engine/02-RESEARCH.md
@.planning/phases/02-decision-tree-engine/02-CONTEXT.md
@.planning/phases/02-decision-tree-engine/02-01-SUMMARY.md

Key existing files:
@src/types/tree.ts
@src/lib/tree-data.ts
@src/lib/tree-engine.ts
@src/app/globals.css (has slide transition CSS classes)
@src/store/quiz-store.ts (reference for Zustand persist pattern -- do NOT modify)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Zustand tree store with persist and history stack</name>
  <files>
    src/store/tree-store.ts
  </files>
  <action>
    Create `src/store/tree-store.ts` as a Zustand store with `persist` middleware for localStorage.

    **Store interface (TreeState):**
    ```
    currentNodeId: string
    answers: Record<string, string>    // nodeId -> optionKey
    history: string[]                  // Stack of nodeIds for back navigation
    userName: string | null
    outcomeId: string | null
    sessionStartedAt: string | null
    isHydrated: boolean                // Tracks Zustand hydration from localStorage
    ```

    **Actions:**
    - `startSession(userName: string | null)`: Sets userName, sessionStartedAt, resets currentNodeId to startNodeId, clears answers/history/outcomeId.
    - `selectOption(optionKey: string)`: Core navigation logic:
      1. Get current node's existing answer (if any).
      2. If existing answer differs from new optionKey (user changed their mind after going back):
         - Find current node's position in history.
         - Trim history to only include nodes up to current position.
         - Delete answers for all nodes that were after current position in the old history (silent downstream discard per CONTEXT.md).
      3. Record the new answer: `answers[currentNodeId] = optionKey`.
      4. Push currentNodeId to history stack.
      5. Get next node via `getNextNodeId(italianTree, currentNodeId, optionKey)`.
      6. If next node is terminal (`isTerminalNode`), set `outcomeId = nextNodeId`.
      7. Set `currentNodeId = nextNodeId`.
    - `goBack()`: If history is empty, return. Pop last nodeId from history. Set currentNodeId to popped value. Clear outcomeId if set. Do NOT remove the answer for the node we're going back to (it stays highlighted as previously selected).
    - `reset()`: Clear all state back to initial values.
    - `setHydrated()`: Set `isHydrated = true` (called from `onRehydrateStorage`).

    **Persist config:**
    - `name: 'sospermesso-tree-session'`
    - `storage: createJSONStorage(() => localStorage)`
    - `partialize`: persist `currentNodeId`, `answers`, `history`, `userName`, `outcomeId`, `sessionStartedAt` (NOT `isHydrated`).
    - `onRehydrateStorage`: return a callback that calls `setHydrated()` after rehydration completes (the second argument indicates success/error).

    **Initial state:**
    - `currentNodeId: italianTree.startNodeId`
    - All other values: null, empty, or false as appropriate.
    - `isHydrated: false`

    Add `'use client'` directive at top.

    Import from `zustand` and `zustand/middleware`. Import `italianTree` from `@/lib/tree-data` and engine functions from `@/lib/tree-engine`.

    CRITICAL: The downstream discard logic must handle the case where a user goes back several steps and changes an answer at step 2 of a 6-step path. All answers from steps 3-6 on the OLD branch must be removed. Test mentally with the minor path: user goes start -> q_situazione (selects "minore") -> minore_start -> min_parenti -> min_par_ita1 -> min_affido1. User goes back to min_parenti and selects "Nonno/a" instead. Answers for min_par_ita1 and min_affido1 must be discarded.
  </action>
  <verify>
    `npx tsc --noEmit` passes. The store file exists and exports `useTreeStore`. Verify by running:
    ```
    npx tsx -e "
      const mod = require('./src/store/tree-store');
      console.log('useTreeStore exported:', typeof mod.useTreeStore === 'function');
    "
    ```
  </verify>
  <done>
    - `src/store/tree-store.ts` exports `useTreeStore` Zustand store
    - Store has all 5 actions: startSession, selectOption, goBack, reset, setHydrated
    - Persist middleware configured with `sospermesso-tree-session` localStorage key
    - selectOption implements silent downstream discard when changing an answer
    - goBack preserves the previous answer (pre-selected state)
    - TypeScript compiles cleanly
  </done>
</task>

<task type="auto">
  <name>Task 2: Create tree UI components (AnswerCard, QuestionScreen, SlideTransition, TreePlayer)</name>
  <files>
    src/components/tree/AnswerCard.tsx
    src/components/tree/QuestionScreen.tsx
    src/components/tree/SlideTransition.tsx
    src/components/tree/TreePlayer.tsx
    src/components/tree/index.ts
  </files>
  <action>
    Create the `src/components/tree/` directory and all components. All are `'use client'` components.

    **1. `AnswerCard.tsx`:**
    A tappable card for a single answer option.
    Props: `label: string`, `description?: string`, `selected: boolean`, `onSelect: () => void`, `disabled: boolean`.
    - Full-width button with `rounded-xl border-2 border-foreground` styling.
    - Uses `text-start` (logical property, not text-left).
    - Selected state: `bg-foreground text-primary-foreground` (black bg, yellow text per design system).
    - Unselected: `bg-card text-card-foreground hover:bg-foreground/10`.
    - Minimum height `min-h-[48px]` for touch targets.
    - `active:scale-[0.98]` for tactile feedback.
    - Description text: `mt-1 block text-sm font-normal opacity-80`.
    - When `disabled`, add `pointer-events-none opacity-70`.

    **2. `QuestionScreen.tsx`:**
    Renders a single question with its answer options.
    Props: `question: string`, `description?: string`, `options: TreeEdge[]`, `selectedOptionKey: string | null`, `onSelect: (optionKey: string) => void`, `disabled: boolean`.
    - Centered layout within the viewport.
    - Question text: `text-2xl font-bold leading-tight` at top.
    - Description (if present): `mt-2 text-foreground/70`.
    - Answer cards: vertical stack with `gap-3 mt-8`.
    - Maps over `options` to render `<AnswerCard>` for each, passing `selected={option.optionKey === selectedOptionKey}`.
    - For the `q_situazione` node (the one with 9 options), implement category grouping as a VISUAL-ONLY presentation. Detect this by checking if `options.length > 5`. When detected, group the options under bold category headings:
      - "La tua situazione personale" (minore, nato in Italia, salute, figlio)
      - "Famiglia e relazioni" (famiglia, amore)
      - "Protezione e sicurezza" (paura, brutta situazione)
      - "Altro" (nessuna di queste)
      The grouping is purely visual -- each option is still a direct answer to q_situazione. Category headings are non-interactive `<h3>` elements with `text-sm font-semibold text-foreground/60 uppercase tracking-wide mt-6 first:mt-0 mb-2`. Hardcode the category mapping by optionKey. This is the only question that needs grouping.

    **3. `SlideTransition.tsx`:**
    Wrapper component for CSS slide animations between questions.
    Props: `nodeId: string` (key to detect changes), `direction: 'forward' | 'back'`, `children: React.ReactNode`.
    - Uses `useState` for visibility and `useRef` for previous nodeId tracking.
    - When `nodeId` changes:
      1. Set invisible (opacity 0, translated in exit direction).
      2. After 200ms timeout, update displayed children.
      3. On next frame (`requestAnimationFrame`), set visible (opacity 1, translate 0).
    - Translate amounts: `translate-x-5` for forward enter, `-translate-x-5` for back enter.
    - RTL: Use `rtl:-translate-x-5` and `rtl:translate-x-5` to mirror directions.
    - Transition: `transition-all duration-300 ease-out`.

    **4. `TreePlayer.tsx`:**
    Main orchestrator that renders the current question.
    - Reads `currentNodeId`, `answers` from `useTreeStore`.
    - Gets `selectOption` action from store.
    - Uses local state: `direction` ('forward' | 'back'), `isTransitioning` (boolean).
    - Gets current node via `getNode(italianTree, currentNodeId)`.
    - Gets options via `getOptionsForNode(italianTree, currentNodeId)`.
    - `handleSelect(optionKey)`: If `isTransitioning`, return (prevent double-tap). Set `isTransitioning = true`, set `direction = 'forward'`. After 200ms delay (to show selected card state), call `selectOption(optionKey)` and set `isTransitioning = false`.
    - Listen for store's `goBack` to set `direction = 'back'`. Use `useEffect` that subscribes to `useTreeStore.subscribe` to detect when history length decreases (indicating goBack was called), and set direction to 'back'.
    - If node is null or type !== 'question', return null (terminal nodes handled by parent).
    - Render: `<SlideTransition nodeId={currentNodeId} direction={direction}>` wrapping `<QuestionScreen>`.

    **5. `index.ts`:**
    Barrel exports:
    ```ts
    export { AnswerCard } from './AnswerCard';
    export { QuestionScreen } from './QuestionScreen';
    export { SlideTransition } from './SlideTransition';
    export { TreePlayer } from './TreePlayer';
    ```
  </action>
  <verify>
    `npx tsc --noEmit` passes. All 5 files exist in `src/components/tree/`. Verify exports:
    ```
    npx tsx -e "
      const tree = require('./src/components/tree');
      console.log('Exports:', Object.keys(tree));
    "
    ```
    Expected: AnswerCard, QuestionScreen, SlideTransition, TreePlayer.
  </verify>
  <done>
    - All 5 files created in `src/components/tree/`
    - AnswerCard renders tappable cards with selected/unselected states and 48px+ touch targets
    - QuestionScreen renders question text + answer card list, with category grouping for q_situazione
    - SlideTransition animates forward/back with RTL-aware translations
    - TreePlayer orchestrates question rendering with tap-to-advance delay and double-tap prevention
    - TypeScript compiles cleanly
    - All components use logical CSS properties (text-start, not text-left)
  </done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes with all new files
- Store exports useTreeStore with all actions
- All tree components export correctly from barrel
- No physical direction CSS properties used (no text-left, ml-, mr-)
</verification>

<success_criteria>
1. Zustand store persists session to localStorage under 'sospermesso-tree-session'
2. selectOption handles downstream answer discard correctly
3. goBack preserves previous answer selection
4. AnswerCard has 48px+ touch targets with proper selected/unselected styling
5. QuestionScreen groups q_situazione's 9 options into categories
6. SlideTransition animates correctly in both LTR and RTL
7. TreePlayer prevents double-tap during transitions
8. All files compile with no TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/02-decision-tree-engine/02-02-SUMMARY.md`
</output>
