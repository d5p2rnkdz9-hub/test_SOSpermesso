---
phase: 01-i18n-foundation-design-system
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - next.config.ts
  - src/i18n/routing.ts
  - src/i18n/request.ts
  - src/i18n/navigation.ts
  - src/proxy.ts
  - src/app/layout.tsx
  - src/app/[locale]/layout.tsx
  - src/app/[locale]/page.tsx
  - src/app/[locale]/not-found.tsx
  - messages/it.json
  - messages/ar.json
  - messages/fr.json
  - messages/en.json
  - messages/es.json
autonomous: true

must_haves:
  truths:
    - "Navigating to / redirects to /it/ (default locale)"
    - "Navigating to /ar/ renders with dir=rtl and lang=ar on the html element"
    - "Navigating to /it/ renders with dir=ltr and lang=it on the html element"
    - "Arabic pages load IBM Plex Sans Arabic font, Latin pages load Inter"
    - "All 5 locale paths (/it/, /ar/, /fr/, /en/, /es/) resolve without 404"
  artifacts:
    - path: "src/i18n/routing.ts"
      provides: "Locale routing configuration"
      contains: "defineRouting"
    - path: "src/i18n/request.ts"
      provides: "Per-request locale + message loading"
      contains: "getRequestConfig"
    - path: "src/i18n/navigation.ts"
      provides: "Locale-aware Link, redirect, usePathname, useRouter"
      contains: "createNavigation"
    - path: "src/proxy.ts"
      provides: "next-intl middleware for locale routing"
      contains: "createMiddleware"
    - path: "src/app/[locale]/layout.tsx"
      provides: "Locale-aware layout with dir, lang, fonts, DirectionProvider"
      contains: "DirectionProvider"
    - path: "messages/it.json"
      provides: "Italian UI strings"
    - path: "messages/ar.json"
      provides: "Arabic UI strings"
  key_links:
    - from: "src/proxy.ts"
      to: "src/i18n/routing.ts"
      via: "import routing config"
      pattern: "import.*routing"
    - from: "src/app/[locale]/layout.tsx"
      to: "src/i18n/routing.ts"
      via: "generateStaticParams uses routing.locales"
      pattern: "routing\\.locales"
    - from: "src/i18n/request.ts"
      to: "messages/*.json"
      via: "dynamic import of message files"
      pattern: "import.*messages"
---

<objective>
Set up next-intl i18n routing infrastructure with [locale] URL segments, configuring all 5 locales (it, ar, fr, en, es) with Italian as default. Restructure the app directory under a [locale] segment with proper font loading (Inter for Latin, IBM Plex Sans Arabic for Arabic), DirectionProvider for RTL, and NextIntlClientProvider for client-side translations.

Purpose: This is the foundational i18n plumbing that every subsequent phase depends on. Locale-aware routing, RTL direction switching, and font loading must work before any UI work can begin.
Output: Working locale routing where all 5 locale paths resolve, direction switches between LTR/RTL based on locale, and fonts load correctly per script.
</objective>

<execution_context>
@/Users/albertopasquero/.claude/get-shit-done/workflows/execute-plan.md
@/Users/albertopasquero/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-i18n-foundation-design-system/01-RESEARCH.md
@.planning/phases/01-i18n-foundation-design-system/01-CONTEXT.md

Key existing files to reference:
@src/app/layout.tsx (current root layout -- will be restructured)
@src/app/page.tsx (current homepage -- redirects to /quiz)
@next.config.ts (currently empty config)
@tsconfig.json (uses src/ directory with @/* path alias)
@components.json (shadcn config -- new-york style)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install next-intl and create i18n configuration files</name>
  <files>
    package.json
    next.config.ts
    src/i18n/routing.ts
    src/i18n/request.ts
    src/i18n/navigation.ts
    src/proxy.ts
    messages/it.json
    messages/ar.json
    messages/fr.json
    messages/en.json
    messages/es.json
  </files>
  <action>
    1. Install next-intl:
       ```
       npm install next-intl
       ```

    2. Create `src/i18n/routing.ts`:
       ```typescript
       import { defineRouting } from 'next-intl/routing';

       export const routing = defineRouting({
         locales: ['it', 'ar', 'fr', 'en', 'es'],
         defaultLocale: 'it',
         localePrefix: 'always',
       });
       ```
       Use `localePrefix: 'always'` so every URL has an explicit locale prefix (matches sospermesso.it structure).

    3. Create `src/i18n/request.ts`:
       ```typescript
       import { getRequestConfig } from 'next-intl/server';
       import { hasLocale } from 'next-intl';
       import { routing } from './routing';

       export default getRequestConfig(async ({ requestLocale }) => {
         const requested = await requestLocale;
         const locale = hasLocale(routing.locales, requested)
           ? requested
           : routing.defaultLocale;

         return {
           locale,
           messages: (await import(`../../messages/${locale}.json`)).default,
         };
       });
       ```

    4. Create `src/i18n/navigation.ts`:
       ```typescript
       import { createNavigation } from 'next-intl/navigation';
       import { routing } from './routing';

       export const { Link, redirect, usePathname, useRouter, getPathname } =
         createNavigation(routing);
       ```

    5. Create `src/proxy.ts` (NOT middleware.ts -- Next.js 16 uses proxy.ts):
       ```typescript
       import createMiddleware from 'next-intl/middleware';
       import { routing } from './i18n/routing';

       export default createMiddleware(routing);

       export const config = {
         matcher: '/((?!api|trpc|_next|_vercel|.*\\..*).*)',
       };
       ```
       IMPORTANT: File must be at `src/proxy.ts` (not project root) because project uses src/ directory.

    6. Update `next.config.ts` to use next-intl plugin:
       ```typescript
       import type { NextConfig } from 'next';
       import createNextIntlPlugin from 'next-intl/plugin';

       const nextConfig: NextConfig = {};
       const withNextIntl = createNextIntlPlugin();

       export default withNextIntl(nextConfig);
       ```

    7. Create message JSON files for all 5 locales in `messages/` directory (at project root, NOT in src/).
       Phase 1 scope: navigation + layout strings only.

       `messages/it.json`:
       ```json
       {
         "common": {
           "back": "Indietro",
           "next": "Avanti",
           "start": "Inizia",
           "loading": "Caricamento...",
           "error": "Si e' verificato un errore"
         },
         "welcome": {
           "title": "Verifica il tuo diritto al permesso di soggiorno",
           "subtitle": "Rispondi ad alcune domande per scoprire quale permesso puoi richiedere",
           "start": "Inizia la verifica",
           "disclaimer": "Questo strumento fornisce informazioni generali, non consulenza legale."
         },
         "header": {
           "backToStart": "Torna all'inizio"
         },
         "language": {
           "selectLanguage": "Seleziona lingua"
         }
       }
       ```

       `messages/ar.json`:
       ```json
       {
         "common": {
           "back": "\u0631\u062c\u0648\u0639",
           "next": "\u0627\u0644\u062a\u0627\u0644\u064a",
           "start": "\u0627\u0628\u062f\u0623",
           "loading": "\u062c\u0627\u0631\u064d \u0627\u0644\u062a\u062d\u0645\u064a\u0644...",
           "error": "\u062d\u062f\u062b \u062e\u0637\u0623"
         },
         "welcome": {
           "title": "\u062a\u062d\u0642\u0642 \u0645\u0646 \u062d\u0642\u0643 \u0641\u064a \u062a\u0635\u0631\u064a\u062d \u0627\u0644\u0625\u0642\u0627\u0645\u0629",
           "subtitle": "\u0623\u062c\u0628 \u0639\u0646 \u0628\u0639\u0636 \u0627\u0644\u0623\u0633\u0626\u0644\u0629 \u0644\u0645\u0639\u0631\u0641\u0629 \u0623\u064a \u062a\u0635\u0631\u064a\u062d \u064a\u0645\u0643\u0646\u0643 \u0627\u0644\u062a\u0642\u062f\u0645 \u0644\u0644\u062d\u0635\u0648\u0644 \u0639\u0644\u064a\u0647",
           "start": "\u0627\u0628\u062f\u0623 \u0627\u0644\u0641\u062d\u0635",
           "disclaimer": "\u062a\u0642\u062f\u0645 \u0647\u0630\u0647 \u0627\u0644\u0623\u062f\u0627\u0629 \u0645\u0639\u0644\u0648\u0645\u0627\u062a \u0639\u0627\u0645\u0629 \u0648\u0644\u064a\u0633\u062a \u0627\u0633\u062a\u0634\u0627\u0631\u0629 \u0642\u0627\u0646\u0648\u0646\u064a\u0629."
         },
         "header": {
           "backToStart": "\u0627\u0644\u0639\u0648\u062f\u0629 \u0625\u0644\u0649 \u0627\u0644\u0628\u062f\u0627\u064a\u0629"
         },
         "language": {
           "selectLanguage": "\u0627\u062e\u062a\u0631 \u0627\u0644\u0644\u063a\u0629"
         }
       }
       ```

       `messages/fr.json`:
       ```json
       {
         "common": {
           "back": "Retour",
           "next": "Suivant",
           "start": "Commencer",
           "loading": "Chargement...",
           "error": "Une erreur s'est produite"
         },
         "welcome": {
           "title": "Verifiez votre droit au permis de sejour",
           "subtitle": "Repondez a quelques questions pour decouvrir quel permis vous pouvez demander",
           "start": "Commencer la verification",
           "disclaimer": "Cet outil fournit des informations generales, pas des conseils juridiques."
         },
         "header": {
           "backToStart": "Retour au debut"
         },
         "language": {
           "selectLanguage": "Choisir la langue"
         }
       }
       ```

       `messages/en.json`:
       ```json
       {
         "common": {
           "back": "Back",
           "next": "Next",
           "start": "Start",
           "loading": "Loading...",
           "error": "An error occurred"
         },
         "welcome": {
           "title": "Check your right to a residence permit",
           "subtitle": "Answer a few questions to find out which permit you can apply for",
           "start": "Start the check",
           "disclaimer": "This tool provides general information, not legal advice."
         },
         "header": {
           "backToStart": "Back to start"
         },
         "language": {
           "selectLanguage": "Select language"
         }
       }
       ```

       `messages/es.json`:
       ```json
       {
         "common": {
           "back": "Atras",
           "next": "Siguiente",
           "start": "Comenzar",
           "loading": "Cargando...",
           "error": "Se produjo un error"
         },
         "welcome": {
           "title": "Verifica tu derecho al permiso de residencia",
           "subtitle": "Responde algunas preguntas para descubrir que permiso puedes solicitar",
           "start": "Comenzar la verificacion",
           "disclaimer": "Esta herramienta proporciona informacion general, no asesoramiento legal."
         },
         "header": {
           "backToStart": "Volver al inicio"
         },
         "language": {
           "selectLanguage": "Seleccionar idioma"
         }
       }
       ```

    IMPORTANT: Use proper Unicode characters for accented text (e.g., accent marks in French/Spanish/Italian). The escaped Unicode sequences above for Arabic are just for clarity in this plan -- the actual JSON files should contain readable Arabic text.
  </action>
  <verify>
    1. `npm run build` completes without errors (next-intl plugin loads, proxy.ts resolves)
    2. `ls src/i18n/` shows routing.ts, request.ts, navigation.ts
    3. `ls src/proxy.ts` exists
    4. `ls messages/` shows it.json, ar.json, fr.json, en.json, es.json
    5. Each message file is valid JSON: `node -e "require('./messages/it.json')"` (repeat for all 5)
  </verify>
  <done>
    next-intl installed. All i18n config files created. proxy.ts at src/proxy.ts. next.config.ts uses next-intl plugin. All 5 message files exist with Phase 1 navigation/layout strings.
  </done>
</task>

<task type="auto">
  <name>Task 2: Restructure app directory under [locale] segment with fonts and providers</name>
  <files>
    src/app/layout.tsx
    src/app/[locale]/layout.tsx
    src/app/[locale]/page.tsx
    src/app/[locale]/not-found.tsx
  </files>
  <action>
    1. Rewrite `src/app/layout.tsx` as a MINIMAL root layout. It should only contain the HTML skeleton -- no lang, no dir, no fonts (those go in [locale] layout):
       ```tsx
       import type { Metadata } from 'next';
       import './globals.css';

       export const metadata: Metadata = {
         title: 'SOSpermesso - Verifica il tuo diritto al permesso di soggiorno',
         description: 'Scopri quale permesso di soggiorno puoi richiedere in Italia',
       };

       export default function RootLayout({
         children,
       }: {
         children: React.ReactNode;
       }) {
         return children;
       }
       ```
       CRITICAL: Root layout must NOT include `<html>` or `<body>` tags when using next-intl with [locale] layout. The [locale]/layout.tsx provides those. Root layout just passes children through and imports globals.css.

    2. Create `src/app/[locale]/layout.tsx` with:
       - Dynamic `lang` and `dir` on `<html>` based on locale
       - Font loading: Inter (Latin) + IBM Plex Sans Arabic (Arabic) via `next/font/google`
       - Both fonts declared as CSS variables (`--font-sans`, `--font-arabic`)
       - Body class switches active font based on locale direction
       - `DirectionProvider` from `@radix-ui/react-direction` wrapping children
       - `NextIntlClientProvider` wrapping children
       - `setRequestLocale()` call for static rendering support
       - `generateStaticParams()` from routing.locales

       ```tsx
       import { NextIntlClientProvider, hasLocale } from 'next-intl';
       import { setRequestLocale } from 'next-intl/server';
       import { notFound } from 'next/navigation';
       import { Inter } from 'next/font/google';
       import { IBM_Plex_Sans_Arabic } from 'next/font/google';
       import { DirectionProvider } from '@radix-ui/react-direction';
       import { routing } from '@/i18n/routing';

       const inter = Inter({
         subsets: ['latin'],
         variable: '--font-sans',
         display: 'swap',
       });

       const plexArabic = IBM_Plex_Sans_Arabic({
         subsets: ['arabic'],
         weight: ['400', '500', '700'],
         variable: '--font-arabic',
         display: 'swap',
       });

       const RTL_LOCALES = ['ar'] as const;

       type Props = {
         children: React.ReactNode;
         params: Promise<{ locale: string }>;
       };

       export function generateStaticParams() {
         return routing.locales.map((locale) => ({ locale }));
       }

       export default async function LocaleLayout({ children, params }: Props) {
         const { locale } = await params;
         if (!hasLocale(routing.locales, locale)) notFound();
         setRequestLocale(locale);

         const isRtl = RTL_LOCALES.includes(locale as typeof RTL_LOCALES[number]);
         const dir = isRtl ? 'rtl' : 'ltr';

         return (
           <html lang={locale} dir={dir} className={`${inter.variable} ${plexArabic.variable}`}>
             <body className={`antialiased ${isRtl ? 'font-arabic' : 'font-sans'}`}>
               <DirectionProvider dir={dir}>
                 <NextIntlClientProvider>
                   {children}
                 </NextIntlClientProvider>
               </DirectionProvider>
             </body>
           </html>
         );
       }
       ```

       NOTE: `font-arabic` needs to be added to tailwind.config.ts fontFamily (handled in Plan 02). For now, the CSS variable `--font-arabic` is set on the html element. The executor of Plan 02 will wire the Tailwind utility.

    3. Create a basic `src/app/[locale]/page.tsx` placeholder:
       ```tsx
       import { useTranslations } from 'next-intl';
       import { setRequestLocale } from 'next-intl/server';

       type Props = {
         params: Promise<{ locale: string }>;
       };

       export default async function HomePage({ params }: Props) {
         const { locale } = await params;
         setRequestLocale(locale);

         return (
           <div className="flex min-h-screen items-center justify-center p-4">
             <div className="text-center">
               <h1 className="text-3xl font-bold">SOSpermesso</h1>
               <p className="mt-2 text-lg">i18n routing works! Locale: {locale}</p>
             </div>
           </div>
         );
       }
       ```
       This is a temporary placeholder. Plan 03 will replace it with the actual welcome page.

    4. Create `src/app/[locale]/not-found.tsx`:
       ```tsx
       export default function NotFound() {
         return (
           <div className="flex min-h-screen items-center justify-center p-4">
             <div className="text-center">
               <h1 className="text-3xl font-bold">404</h1>
               <p className="mt-2">Page not found</p>
             </div>
           </div>
         );
       }
       ```

    5. The existing `src/app/page.tsx` (which redirects to /quiz) should be REMOVED or replaced. The [locale]/page.tsx now serves as the homepage. Remove `src/app/page.tsx`.

    6. Do NOT move the existing quiz pages (`src/app/quiz/*`) under [locale] yet -- they are Corso AI artifacts that will be replaced in Phase 2. Leave them where they are for now. The proxy.ts matcher will handle them via the API exclusion pattern.

    IMPORTANT: Verify that `@radix-ui/react-direction` is available as a dependency. It should be a transitive dependency of the existing Radix packages. If not, install it explicitly: `npm install @radix-ui/react-direction`.
  </action>
  <verify>
    1. `npm run dev` starts without errors
    2. Navigate to `http://localhost:3000/` -- should redirect to `http://localhost:3000/it/`
    3. Navigate to `http://localhost:3000/it/` -- page renders, inspect HTML element shows `lang="it" dir="ltr"`
    4. Navigate to `http://localhost:3000/ar/` -- page renders, inspect HTML element shows `lang="ar" dir="rtl"`
    5. Navigate to `http://localhost:3000/fr/` -- page renders with `lang="fr" dir="ltr"`
    6. Navigate to `http://localhost:3000/en/` -- page renders with `lang="en" dir="ltr"`
    7. Navigate to `http://localhost:3000/es/` -- page renders with `lang="es" dir="ltr"`
    8. `npm run build` completes successfully
  </verify>
  <done>
    App directory restructured under [locale] segment. Root layout is minimal (no html/body tags). Locale layout sets lang, dir, fonts, DirectionProvider, NextIntlClientProvider. All 5 locale paths render correctly. Arabic renders with dir=rtl. Build succeeds.
  </done>
</task>

</tasks>

<verification>
Run these checks to confirm the plan is complete:

1. **Locale routing:** `curl -sI http://localhost:3000/ | grep Location` shows redirect to `/it/`
2. **RTL direction:** Browser DevTools on `/ar/` shows `<html lang="ar" dir="rtl">`
3. **LTR direction:** Browser DevTools on `/it/` shows `<html lang="it" dir="ltr">`
4. **Build:** `npm run build` succeeds with no errors
5. **Message loading:** No "missing translations" warnings in console
</verification>

<success_criteria>
- next-intl installed and configured with 5 locales
- All locale paths (/it/, /ar/, /fr/, /en/, /es/) render
- Arabic locale sets dir="rtl", all others set dir="ltr"
- Fonts declared as CSS variables on html element
- DirectionProvider wraps all content
- Build succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/01-i18n-foundation-design-system/01-01-SUMMARY.md`
</output>
